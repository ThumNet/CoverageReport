<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Coverage Viewer</title>
    <link rel="stylesheet" href="Thumnet.CoverageReport.Core/Generators/style/main.css" />
</head>

<body>

    <div id="main"></div>

    <script>
        var coverageReport = {
            'lcovSource': 'MoMQXAwmA6CqDOBTATvaApRAzLzEE8A6AFQFcBbclNeAe1OQGNE0JaA3FAQwHNFiWAF2gQANl3jwAMgEsARsi7J8ARhHjJKwo3gBYAFAgAcmABsAGmD54gxOULBByGQDseAAjETp8xcq1emmBgfIIA+gCy+AAKyLQADiiC+AAUAJQGxgAiAIJgAAyW1rb2js5unho+CkqqhIHwKsGhkTFxicjJ6Qa5YADs5vmZJgCcRTZ2hABqtDIAJpXesjX+9VVNYFm03YZGvYVWE/Yz84uSy351DRtbO70qhUP69yqDPXkqAExvzx8AzD97gAWQEfACsPwAQgAlF7mFQgx4GGFwhHwn5ScB9AxSAASBWR0PAn0J+KexmJwzJBkQLjmYVoWDCeEYtGQcwMoEgMAQ1Aw2FwBBIFCoqGgdAYzFYHG4fAENhEMsUcqEhBy8XiIi4okYpHEgjZ2j0uzAY0OJUIAEkXII/p9PErePxVer4vVtbr9Wzgjk5nMUubJtbbd9A/Zg3aMrt7uMLRH7WxOMrnTY1Rr3Tq9VwDcgfX6A8Ugza7bGiyGo/dCip3mAVK9q79a98G8ZayCw1biwnHSrU66M57s97Noh2PNEAWjp2Q6Xw12o9kPrPp3aHUmnfLBGm3RAPVmc8EsqPx5O413l/GK+D4TWVBYG/cBk97gAOUFgT71mufZuE+4WJ8oVhD4APRBsUTyT9zE+N8kX0CCP1eGCwJxcARhxfFsXgokwCBUkP2GSldnxEl9FpelGWZRBWXZTlwCgOAkDFTAcDwIgyEoPkJSYFhFXXXthETWUUy3V1oFiWgeEUewdGGfplxOBYhOTTdt0ICSpK4chggiLhXFPSYylcHgAG0AF0Fz2PIDkLY5ZiUnsRLUjTpJ0vSXAM0onGM8yrzAWCazGZ8PjgzEwD+DCCWw8AnhhaldnAFsjHi8iGSZFk2Q5fQuQY3lmIFNjhU4sVuKlPjhM3cqVJdDVoGAUg5AAK2owQAHksGII05LNWyHG8iplI3Gq3XqpqWvagADDYjC0xB2p2RcCmXIyBsc1T+1G5rGDarApuCGaqHmvyHnfOtTu+J4woi/Q8SimEYvw8kjESqkotSyiMvZIA=',
            'C:\\Users\\Jeffrey.Tummers\\sources\\CoverageTest\\ClassLibrary1\\Class1.cs': 'K4Zwlgdg5gBAygTxAFwKYFsDcBYAUHiAQ3VRAAdCBjVGAYQBtCQQAZMAIwCdDOEBGPAG88MUTDLB29MJRiVGzOgpADcYmMLXqxEqTJgpOkWAFkEABU4B7Mqk7IEGmFFTJMB1+4C+eEdtG60rIAblZgACYwACJWABQAlH7+mv7+YABmMLGGxgB0AJIgAHLA9PQA8pwAouhkDrFmljZ2DvGJWqliKZ2pjda29o4AvDAARDV1CKM4HT0+s+rzi3jzQA',
            'C:\\Users\\Jeffrey.Tummers\\sources\\CoverageTest\\CoverageTest.App\\Calculator.cs': 'K4Zwlgdg5gBAygTxAFwKYFsDcBYAUKSWRFDAOgGEB7AG2tQGNkxKIRSBxVCVAJzHpz5w0eEjTpSAFVQAPZILwQAhulQgADkvqoYVAG68lUVNJSkAguvV4A3nhgOY64ACNq/GPWpKQIXUup6YG9kSh57RztcRxinV3d6GEhkGHMAEzSACmSYCGB0F14ARgAaJIgUvILeACYASgjYmCimpp5UZGAeCFz8wp4imABqXuqeGsFWmABfPEbY5zcPHIARVD0wNNRsitH+0vLKvtqG6NaWqccwADMYTKr9mABeJ5gABlPLyPmvh2QACx4lAA7rlUKDzDwoPkuMgAKIybTqJgsTIAIjWGy2MBcCBgAC9eJQ0WVlKpKNd7scBnU6pNfrNcD9Wu1Ot09rVnq9BgB+DkDGAALn5gwA9PyJsyHIyYozGUA==',
            'C:\\Users\\Jeffrey.Tummers\\sources\\CoverageTest\\CoverageTest.App\\Program.cs': 'K4Zwlgdg5gBAygTxAFwKYFsDcBYAUHiAQ3VRAAdCBjVGAYQHsA3VAJ0KlQBVTkA6AQTJk8AbzwwJMSgBtCIEDAAKLelDbpxksbkm6YKQsjCUYjemAAmMALKFIAChQtIUANoBdGIRZQQASk09GG0goIYIEHppVF4AdWc0ABlIVHsAIgAJVGlpehhY+hZpCwBCNL8cHVCAX0CYWtwGoA==',
            'C:\\Users\\Jeffrey.Tummers\\sources\\CoverageTest\\CoverageTest.App\\SubjectOfT.cs': 'K4Zwlgdg5gBAygTxAFwKYFsDcBYAUKSWRFDAOgGEB7AG2tQGNkxKIRSBxVCVAJzHpz5w0eEjTpSAFVQAPZILwQAhulQgADkvqoYVAG68lUVNJSkAguvV4A3nhgOY64ACNq/GPWpKQIeK4ArBmQAeQAzAB5JAD57RztcRySnV3d6GBQ+EQA5FVRwgAoASjjkmASysp5UZGAeCBhkBHVUSjCCySLSXNVBSpgAX1LBvCHcIA===',
        };
    </script>

    <script id="mainTemplate" type="text/template">
        <h1>Coverage report</h1>

        <span class="stats" style="background-color:<%- getColor(model.totals.lines.percentage) %>;"> <%- model.totals.lines.hit %>/<%- model.totals.lines.found %> Lines (<%- model.totals.lines.percentage %>%)</span>
        <span class="stats" style="background-color:<%- getColor(model.totals.branches.percentage) %>;"> <%- model.totals.branches.hit %>/<%- model.totals.branches.found %> Branches (<%- model.totals.branches.percentage %>%)</span>
        <span class="stats" style="background-color:<%- getColor(model.totals.functions.percentage) %>;"> <%- model.totals.functions.hit %>/<%- model.totals.functions.found %> Functions (<%- model.totals.functions.percentage %>%)</span>
        
        <h2>Files</h2>

        <table class="sortable">
            <thead>
                <tr>
                    <th>File</th>
                    <th class="sorttable_nosort divider-left">Lines</th>
                    <th></th>
                    <th class="sorttable_numeric"></th>
                    <th class="sorttable_nosort divider-left">Branches</th>
                    <th></th>
                    <th class="sorttable_numeric"></th>
                    <th class="sorttable_nosort divider-left">Functions</th>
                    <th></th>
                    <th class="sorttable_numeric"></th>
                </tr>
            </thead>
            <tbody>
                <% _.each( model.listItems, function( item ){ %>
                <tr>
                    <td><a href="#file=<%- encodeURI(item.file) %>"><%- item.shortFile %></a></td>

                    <td class="divider-left">
                        <div class="progress">
                            <div class="bar" style="width:<%- item.line %>%;background-color:<%- getColor(item.line) %>;"></div>
                        </div>
                    </td>
                    <td><%- item.line %>%</td>
                    <td><%- item.lcov.lines.hit %>/<%- item.lcov.lines.found %></td>

                    <td class="divider-left">
                        <div class="progress">
                            <div class="bar" style="width:<%- item.branch %>%;background-color:<%- getColor(item.branch) %>;"></div>
                        </div>
                    </td>
                    <td><%- item.branch %>%</td>
                    <td><%- item.lcov.branches.hit %>/<%- item.lcov.branches.found %></td>

                    <td class="divider-left">
                        <div class="progress">
                            <div class="bar" style="width:<%- item.function %>%;background-color:<%- getColor(item.function) %>;"></div>
                        </div>
                    </td>
                    <td><%- item.function %>%</td>
                    <td><%- item.lcov.functions.hit %>/<%- item.lcov.functions.found %></td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </script>

    <script id="fileTemplate" type="text/template">
        <h1>File report</h1>

        <span class="stats" style="background-color:<%- getColor(model.item.line) %>;"> <%- model.item.lcov.lines.hit %>/<%- model.item.lcov.lines.found %> Lines (<%- model.item.line %>%)</span>
        <span class="stats" style="background-color:<%- getColor(model.item.branche) %>;"> <%- model.item.lcov.branches.hit %>/<%- model.item.lcov.branches.found %> Branches (<%- model.item.branch %>%)</span>
        <span class="stats" style="background-color:<%- getColor(model.item.function) %>;"> <%- model.item.lcov.functions.hit %>/<%- model.item.lcov.functions.found %> Functions (<%- model.item.function %>%)</span>

        <p>File: <%- model.item.shortFile %></p>
        <p><a href="#">Back</a></p>

        <div class="code">
            <% _.each(model.source.split('\n'), function(line, index) { %>
            <p class="<%- getLineClass(model.item.lcov, index+1) %>"><%- line %></p>
            <% }); %>
        </div>
        <!--<pre><%- model.source %></pre>-->
    </script>

    <script src="Thumnet.CoverageReport.Core/Generators/scripts/tools.js"></script>
    <script src="Thumnet.CoverageReport.Core/Generators/scripts/underscore-min.js"></script>
    <script src="Thumnet.CoverageReport.Core/Generators/scripts/lcov-parse-min.js"></script>
    <script src="Thumnet.CoverageReport.Core/Generators/scripts/lz-string-min.js"></script>
    <script src="Thumnet.CoverageReport.Core/Generators/scripts/sorttable.js"></script>
    <script src="coverage-private.js"></script>

    <script>
        _.templateSettings.variable = 'model';
        var mainTemplate = _.template(document.getElementById('mainTemplate').textContent);
        var fileTemplate = _.template(document.getElementById('fileTemplate').textContent);

        var tCoverage = { lcovData: null, currentItem: null, totals: null, longestPath: '', items: [] };

        function HashHandler(e) {
            handleRoute(e.newURL);
        }

        function LoadHandler() {
            readCoverage();
            setTimeout(checkHash, 200);
        }

        function checkHash() {
            handleRoute(window.location.toString());
        }

        function handleRoute(url) {
            var parts = parseHashBangArgs(url);
            if (!parts) {
                showHome();
                return;
            }

            if (parts.file) {
                showFile(parts.file);
            }
        }

        function getColor(percentage){
            //percentage from 0 to 100
            var hue=((percentage/100)*120).toString(10);
            return ["hsl(",hue,",50%,50%)"].join("");
        }

        function getCoverageClass(percentage) {
            return percentage > 60 
                ? percentage > 80 ? 'good' : '' 
                : 'poor'; 
        }

        function getLineClass(lcovItem, lineNumber) {
            var line = _.find(lcovItem.lines.details, function (item) { return item.line === lineNumber; });
            var func = _.find(lcovItem.functions.details, function (item) { return item.line === lineNumber; });
            var subject = line || func;
            return !subject ? 'notmeasured' : subject.hit === 0 ? 'nothit' : 'hit';
        }

        function showFile(filePath) {
            if (!tCoverage.lcovData) { return; }

            var item = _.find(tCoverage.items, function (item) { return item.file === filePath; });
            tCoverage.currentItem = item;
            var sourceCompressed = coverageReport[filePath];
            var source = LZString.decompressFromBase64(sourceCompressed);
            loadTemplate(fileTemplate, { item: item, source: source });
        }

        function showHome() {
            if (!tCoverage.lcovData) { return; }

            loadTemplate(mainTemplate, { totals: tCoverage.totals, listItems: tCoverage.items });
            var table = document.querySelectorAll('table.sortable')[0];
            sorttable.makeSortable(table);
        }

        function loadTemplate(template, data) {
            var main = document.getElementById('main');
            main.innerHTML = template(data);
        }

        function percentage(part, set) {
            return ((part / set) * 100).toFixed(2);
        }

        function readCoverage() {
            var lcovCompressed = coverageReport['lcovSource'];
            var lcovSrc = LZString.decompressFromBase64(lcovCompressed);

            lcov_parse(lcovSrc.trim(), function (err, data) {
                if (err) { console.error(err); return; }

                tCoverage.longestPath = longest_common_str(data.map(function (item) { return item.file; }), '\\');

                var items = [],
                    totals = {
                        lines: { hit: 0, found: 0 },
                        branches: { hit: 0, found: 0 },
                        functions: { hit: 0, found: 0 }
                    };

                for (var i = 0; i < data.length; i++) {
                    totals.lines.hit += data[i].lines.hit;
                    totals.lines.found += data[i].lines.found;
                    totals.branches.hit += data[i].branches.hit;
                    totals.branches.found += data[i].branches.found;
                    totals.functions.hit += data[i].functions.hit;
                    totals.functions.found += data[i].functions.found;

                    items.push({
                        file: data[i].file,
                        lcov: data[i],
                        shortFile: data[i].file.replace(tCoverage.longestPath, ''),
                        line: percentage(data[i].lines.hit, data[i].lines.found),
                        branch: percentage(data[i].branches.hit, data[i].branches.found),
                        function: percentage(data[i].functions.hit, data[i].functions.found)
                    });
                }

                var paths = items.map(function (item) { return item.shortFile.replace(/\\/g, '/'); });
                var tree = hierarchy(paths);
                console.log(tree);

                totals.lines.percentage = percentage(totals.lines.hit, totals.lines.found);
                totals.branches.percentage = percentage(totals.branches.hit, totals.branches.found);
                totals.functions.percentage = percentage(totals.functions.hit, totals.functions.found);

                tCoverage.totals = totals;
                tCoverage.lcovData = data;
                tCoverage.items = items;
            });
        }

        window.addEventListener("hashchange", HashHandler, false);
        window.addEventListener("load", LoadHandler, false);
    </script>

</body>

</html>
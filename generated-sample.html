<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Coverage Viewer</title>
    <link rel="stylesheet" href="Thumnet.CoverageReport.Core/Generators/style/main.css" />
</head>

<body>

    <div id="main"></div>

    <script id="lcovSource" type="text/template">
        ᥡ䐷Ƥ恚հ㎡☢㯺Ūၓី䅜ǰŰ଀᛼䪋怾檒ƭুᚠ湈ѐຈ墶N栰布怡䠤堢ᭂ癯䀱䉜㉪慦砠偀Ą怡堠榣珤౮⡸႒ಠ㬾$ㄳ吆ᝊ椙嘦Єࠣ琡㌘%㉍!抨០pŉ稦1@䰠î㓖嫻洼⼎൏ʲ啰倏Ŵܧ䋂㈑摤檎孌.敕柅䀡ᰥ⬻℠൶䍀ŗᚚ擋㻕દ堦㚳墍濨妮泇㐓䥥侭⻍㇙漉Ⰴڎ⬝⺼䪠঩玐ڀ糜x㾀ઠւ㰠℠ॡ畐唟᷷₥⅐瑉犳䁝⺪†┒碘ḥ㶑池梇揲⊎䢢㢆Ⴭ֡Ԑ䙍ಡ䶔偄̠⇈ౖ஠ၨਵદ䄈ٓૠ燘㸠䖁ࡅ䔴呄გ壌≂煤䙉ไࢹ派䢆൦⋁$䥙ɯ嘎燫㲞ᅼ囥㖕㍽啓Ō䚃᥄箃⳱㟜㼑俹㗅嬷䣴ྻᜋ㎯ᗺ噅╴璊嫎ݼ䏛Ἇドယᇻᡚ秄㞜䕬稣དྷ朎禶ۄぐⵦ囖ᙛ㝫ɤ燱͛⨔灁䩁汹儭倍⛆罞‛⇬屐浯冶牿ಖ༄时䷛歡碚Ἒᐙ烜Ⳝ⃊昆ㆿÞ异砠ᰠ毲彎幕湆獓⾀摜絑穯䉇቞匵現㡠֠⁄݂㋵ବ౻ூࡼ̜䉢߄剰掂ɲ䭲婾䩀䙹䫒瀪Ǡ␨⪀ᰯİ㈲䆒ᅩ䃐奵塊ᥩ㧦盳孠梶䄐䔶愈䆯叮䎮㏑㛾楆ṏ䖐爰ᆤ⸹戎熤単ḠΈ}ഃ奇⢳භ✶巄缿ጴ厬厪Φ勔爆Š禂ᢏ⁇ր柯ʑሹ珡㥂┡᥃䒐䵇␹ፂ擹⤹摈位␙ᴴᐸ壌挬催䩘撺喠⤧ဠᖡర\䬦ႚ傁ഓ啫ᔂ㖭⹩䭍昙⣈&㖠择䐨喌姯ቮ䫍捵ᗳ姸泏ᙐ䋋Õ䂭啰从曼e≜杍烂瀽斂潜,ࡷ搸瀶堸牨ᘁ僙䤠
    </script>

    <script id="C:\Users\Jeffrey.Tummers\sources\CoverageTest\ClassLibrary1\Class1.cs" type="text/template">
        ᗣ᱅䄌຀Ȧ⠳戠尪き䃼ˠԧ䐢෵∠ݢ̺冠゠᭢₠٬f½ڐ䁦Ḡ潜ᣂルϗ匩⌲凓ᴥဣ㣤挫⽶ᅊ♬੮䣐ƄࠠᕘϹ䫄癠䇆੊㉬Ϗ渢紐䞍෶䫨ü嚀3ఠѪ怡․创絕缞〠᦬ᙐ沀πɨ䀠狠窚\厠੎䍀㫥䵌㚖ޘ扶啌⊹浬㝺渍ภ常1ێ傪᧠甔綇欓䗜㳰
    </script>
    <script id="C:\Users\Jeffrey.Tummers\sources\CoverageTest\CoverageTest.App\Calculator.cs" type="text/template">
        ᗣ᱅䄌຀Ȧ⠳戠尪き䃼ˠԪⓒᅣƤϸǖ媠掄扱ѲΪ債n㈉柮ാऺ㩲J吠ứ̐․ᯅ℠Ą彵صW⽅⣉割䠤௏⯠ง䌡晚瀠⎊繑痉ᒡ״嵯☦筂⢙皮㭼⎬⧵漏↤䍀懬F㒠Ւ☢మ䆕瀢ᠠ㑩࠴幡㞠ӠӀ䛤惂䵭Ṵ㉐ޢி䱉焴怡哝檾඀嗆+珤㛧᳼ṙ1⨾䰭᪭䣍ဖ䯫ᖝ媦璋◊㤆#ᣢ㋋筐~Ꮼ!䪙㲯䶜ᶰ6ṅ'㬅⡰㳣慡祎ᤠʨ擺㪩䆂㈠ᄺ懒沀ᜢ̠Ý㱪ശ⭉⩪ᬏ㬼͚仉ᬝ㍼ࠊ毕ᶎ例⭝⽡䀯愄ِ+俬ఠ窞⊌摙ಸ冸攠
    </script>
    <script id="C:\Users\Jeffrey.Tummers\sources\CoverageTest\CoverageTest.App\Program.cs" type="text/template">
        ᗣ᱅䄌຀Ȧ⠳戠尪き䃼ˠԧ䐢෵∠ݢ̺冠゠笠滈ʔᕊu❀ຠ₹ᥜþ㱐ኂ⠡娱ģ!⋾䨻㪑䦃㥆瓡⑌䘲䙃㵐Fᠡ㊥ဠ⡰婢䀭倫冨⋪Р╆佦හਨだ䈉勈帠㫓䴠͉է堡ࠠወ榉㴬ᙞ䋭აȱ匜㡚傠⿀☶宠樠
    </script>
    <script id="C:\Users\Jeffrey.Tummers\sources\CoverageTest\CoverageTest.App\SubjectOfT.cs" type="text/template">
        ᗣ᱅䄌຀Ȧ⠳戠尪き䃼ˠԪⓒᅣƤϸǖ媠掄扱ѲΪ債n㈉柮ാऺ㩲J吠ứ̐․ᯅ℠Ą彵صW⽅⣉割䠤௏⯠ง䌡晚瀠⎊繑痉ᒡު瀥ゆ‣搠映ṩ?ự枋䒒╚巽瑐ᑞࢠ๥⪮ࠠ倢⤃䥐Ӓ奯ᔹణ悡䍀ᇵ⢴ア撱㒷᫈ᓉ䀢絫Θ⇼ဠ
    </script>

    <script id="mainTemplate" type="text/template">
        <h1>Coverage report</h1>
        <p>Total coverage: <%- model.totalCoverage %>%</p>
        <h2>Files</h2>
        <table>
            <thead>
                <tr>
                    <th>File</th>
                    <th>Line</th>
                    <th>Branch</th>
                    <th>Method</th>
                </tr>
            </thead>
            <tbody>
                <% _.each( model.listItems, function( listItem ){ %>
                <tr>
                    <td><a href="#file=<%- encodeURI(listItem.file) %>"><%- listItem.shortFile %></a></td>
                    <td><%- listItem.line %></td>
                    <td><%- listItem.branch %></td>
                    <td><%- listItem.method %></td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </script>

    <script id="fileTemplate" type="text/template">
        <h1>File report</h1>
        <p>File: <%- model.item.shortFile %></p>
        <p><a href="#">Back</a></p>
        <div class="code">
            <% _.each(model.source.split('\n'), function(line, index) { %>
            <p class="<%- getLineClass(model.item.lcov, index+1) %>"><%- line %></p>
            <% }); %>
        </div>
        <!--<pre><%- model.source %></pre>-->
    </script>

    <script src="Thumnet.CoverageReport.Core/Generators/scripts/tools.js"></script>
    <script src="Thumnet.CoverageReport.Core/Generators/scripts/underscore-min.js"></script>
    <script src="Thumnet.CoverageReport.Core/Generators/scripts/lcov-parse-min.js"></script>
    <script src="Thumnet.CoverageReport.Core/Generators/scripts/lz-string-min.js"></script>

    <script>
        _.templateSettings.variable = 'model';
        var mainTemplate = _.template(document.getElementById('mainTemplate').textContent);
        var fileTemplate = _.template(document.getElementById('fileTemplate').textContent);
        
        var tCoverage = { lcovData: null, total: 0, longestPath: '', items: [] };

        function HashHandler(e) {
            handleRoute(e.newURL);
        }

        function LoadHandler() {
            readCoverage();
            setTimeout(checkHash, 200);
        }

        function checkHash() {
            handleRoute(window.location.toString());
        }

        function handleRoute(url) {
            var parts = parseHashBangArgs(url);
            if (!parts) {
                showHome();
                return;
            }

            if (parts.file) {
                showFile(parts.file);
            }
        }

        function getLineClass(lcovItem, lineNumber) {
            var line = _.find(lcovItem.lines.details, function (item) { return item.line === lineNumber; });
            var func = _.find(lcovItem.functions.details, function (item) { return item.line === lineNumber; });
            var subject = line || func;
            return !subject ? 'notmeasured' : subject.hit === 1 ? 'hit' : 'nothit';
        }

        function showFile(filePath) {
            if (!tCoverage.lcovData) { return; }

            var item = _.find(tCoverage.items, function (item) { return item.file === filePath; });
            var sourceCompressed = document.getElementById(filePath).textContent.trim();
            var source = LZString144.decompressFromUTF16(sourceCompressed);
            loadTemplate(fileTemplate, { item: item, source: source });
        }

        function showHome() {
            if (!tCoverage.lcovData) { return; }

            loadTemplate(mainTemplate, { totalCoverage: tCoverage.total, listItems: tCoverage.items });
        }

        function loadTemplate(template, data) {
            var main = document.getElementById('main');
            main.innerHTML = template(data);
        }

        function readCoverage() {
            var lcovCompressed = document.getElementById('lcovSource').textContent.trim();
            var lcovSrc = LZString144.decompressFromUTF16(lcovCompressed);
            lcov_parse(lcovSrc.trim(), function (err, data) {
                if (err) { console.error(err); return; }

                tCoverage.longestPath = longest_common_str(data.map(function (item) { return item.file; }), '\\');

                var hit = 0, 
                    found = 0,
                    items = [];

                for (var i = 0; i < data.length; i++) {
                    hit += data[i].lines.hit;
                    found += data[i].lines.found;
                    items.push({
                        file: data[i].file,
                        lcov: data[i],
                        shortFile: data[i].file.replace(tCoverage.longestPath, ''),
                        line: (data[i].lines.hit / data[i].lines.found) * 100,
                        branch: (data[i].branches.hit / data[i].branches.found) * 100,
                        method: (data[i].functions.hit / data[i].functions.found) * 100,
                    });
                }

                tCoverage.total = (hit / found) * 100;
                tCoverage.lcovData = data;
                tCoverage.items = items;
            });
        }

        window.addEventListener("hashchange", HashHandler, false);
        window.addEventListener("load", LoadHandler, false);
    </script>

</body>

</html>